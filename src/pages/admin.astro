---
import AdminBalanceCard from '../components/admin/AdminBalanceCard.astro';
import AdminCategoryStats from '../components/admin/AdminCategoryStats.astro';
import AdminEmptyState from '../components/admin/AdminEmptyState.astro';
import AdminErrorState from '../components/admin/AdminErrorState.astro';
import AdminFilters from '../components/admin/AdminFilters.astro';
import AdminHeader from '../components/admin/AdminHeader.astro';
import AdminMainStats from '../components/admin/AdminMainStats.astro';
import AdminRegistrationsTable from '../components/admin/AdminRegistrationsTable.astro';
import Card from '../components/ui/Card.astro';
import AdminLayout from '../layouts/AdminLayout.astro';
import type { Registration, RegistrationStatus } from '../services/registration';
import { getAllRegistrations, getRegistrationsWithFilters } from '../services/registration';
import { createServerClient } from '../services/supabase-server';
import { calculateBalance, calculateStats } from '../utils/admin-stats';

// Verificar autenticación usando cliente de servidor con cookies
let isAuthenticated = false;
try {
  console.log('=== Admin Auth Check ===');

  // Debug: Ver qué cookies tenemos
  const cookieHeader = Astro.request.headers.get('cookie') || '';
  console.log('Cookie header:', cookieHeader);

  const supabase = createServerClient(Astro.cookies, Astro.request);
  const { data: { session }, error: sessionError } = await supabase.auth.getSession();

  if (sessionError) {
    console.error('Error getting session:', sessionError);
  }

  console.log('Session found:', !!session);
  if (session) {
    console.log('User ID:', session.user.id);
    console.log('Session expires:', session.expires_at);
  }

  isAuthenticated = !!session;
} catch (e) {
  console.error('Error in auth check:', e);
  isAuthenticated = false;
}

// Si no está autenticado, redirigir al login
if (!isAuthenticated) {
  console.log('No session found. Redirecting to login.');
  return Astro.redirect('/admin/login?redirect=/admin');
}

// Leer query params para filtros
const selectedCategory = Astro.url.searchParams.get('category');
const selectedStatus = Astro.url.searchParams.get('status') as RegistrationStatus | null;

let registrations: Registration[] = [];
let filteredRegistrations: Registration[] = [];
let error: string | null = null;

try {
  // Obtener todas las registraciones para estadísticas
  registrations = await getAllRegistrations();
  
  // Obtener registraciones filtradas directamente desde la base de datos
  filteredRegistrations = await getRegistrationsWithFilters(selectedCategory, selectedStatus);
} catch (e) {
  error = e instanceof Error ? e.message : 'Error desconocido al cargar registros';
}

// Calcular estadísticas usando el helper
const stats = calculateStats(registrations);
const registrationPrice = parseFloat(import.meta.env.PUBLIC_REGISTRATION_PRICE || '10');
const balance = calculateBalance(stats.approvedCount, registrationPrice);
---

<AdminLayout title="Panel de Administración | San Mateo Longboard Festival">
  <AdminHeader />

  <main id="main-content" class="min-h-screen bg-cream py-8 md:py-12">
    <div class="container mx-auto px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16">
      
      <!-- Header -->
      <div class="mb-8 md:mb-12 fade-in-up">
        <h2 class="font-display text-4xl md:text-5xl lg:text-6xl text-black uppercase mb-4 leading-tight tracking-tight">
          Panel de Administración
        </h2>
        <p class="font-body text-base md:text-lg text-dark">
          Gestión de participantes registrados
        </p>
      </div>

      {error ? (
        <AdminErrorState error={error} />
      ) : (
        <>
          <AdminBalanceCard 
            balance={balance}
            approvedCount={stats.approvedCount}
            registrationPrice={registrationPrice}
          />

          <AdminMainStats 
            totalRegistrations={stats.totalRegistrations}
            pendingCount={stats.pendingCount}
            approvedCount={stats.approvedCount}
            rejectedCount={stats.rejectedCount}
            selectedStatus={selectedStatus}
            selectedCategory={selectedCategory}
          />

          <AdminCategoryStats 
            approvedAndRejectedByCategory={stats.approvedAndRejectedByCategory}
            selectedCategory={selectedCategory}
            selectedStatus={selectedStatus}
          />

          <!-- Lista de Registros -->
          <Card
            bgColor="bg-white-warm"
            borderWidth="4"
            shadow="xl"
            padding="lg"
            className="p-6 md:p-8 lg:p-10"
            hover={false}
          >
            <AdminFilters 
              selectedCategory={selectedCategory}
              selectedStatus={selectedStatus}
              totalCount={stats.totalRegistrations}
              filteredCount={filteredRegistrations.length}
            />

            {filteredRegistrations.length === 0 ? (
              <AdminEmptyState 
                hasFilters={!!(selectedCategory || selectedStatus)}
                selectedCategory={selectedCategory}
                selectedStatus={selectedStatus}
              />
            ) : (
              <AdminRegistrationsTable registrations={filteredRegistrations} />
            )}
          </Card>
        </>
      )}
    </div>
  </main>
</AdminLayout>

<style>
  .fade-in-up {
    animation: fadeInUp 0.6s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script src="../scripts/admin-stats-updater.ts"></script>


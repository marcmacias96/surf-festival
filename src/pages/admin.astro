---
import AdminLayout from '../layouts/AdminLayout.astro';
import { getAllRegistrations } from '../services/registration';
import type { Registration, RegistrationStatus } from '../services/registration';
import RegistrationActions from '../components/admin/RegistrationActions';

let registrations: Registration[] = [];
let error: string | null = null;

try {
  registrations = await getAllRegistrations();
} catch (e) {
  error = e instanceof Error ? e.message : 'Error desconocido al cargar registros';
}

// Calcular estad칤sticas
const totalRegistrations = registrations.length;
const statsByCategory = registrations.reduce((acc, reg) => {
  acc[reg.category] = (acc[reg.category] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const statsByStatus = registrations.reduce((acc, reg) => {
  acc[reg.status] = (acc[reg.status] || 0) + 1;
  return acc;
}, {} as Record<RegistrationStatus, number>);

// Estad칤sticas principales
const approvedCount = statsByStatus.approved || 0;
const rejectedCount = statsByStatus.rejected || 0;
const pendingCount = statsByStatus.pending || 0;

// Estad칤sticas por categor칤a - Solo aprobadas
const approvedByCategory = registrations
  .filter(reg => reg.status === 'approved')
  .reduce((acc, reg) => {
    acc[reg.category] = (acc[reg.category] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

// Categor칤as con nombres m치s claros para las m칠tricas
const categories = ['Open Hombres', 'Open Mujeres', 'Mujeres Intermedio', 'Mujeres Principiante', 'Ni침os'];
const categoryLabels: Record<string, string> = {
  'Open Hombres': 'Open H',
  'Open Mujeres': 'Open M',
  'Mujeres Intermedio': 'M. Inter',
  'Mujeres Principiante': 'M. Princ',
  'Ni침os': 'Ni침os'
};
---

<AdminLayout title="Panel de Administraci칩n | San Mateo Longboard Festival">
  <!-- Header Simple del Admin -->
  <header class="bg-white-warm border-b-[4px] border-black shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-4 sm:px-6 md:px-8">
      <div class="flex items-center justify-between py-4">
        <div class="flex items-center gap-4">
          <a href="/" class="flex items-center" aria-label="Volver al inicio">
            <img 
              src="/logo.png" 
              alt="San Mateo Longboard Festival" 
              class="h-10 md:h-12"
              loading="eager"
            />
          </a>
          <div class="h-8 w-[2px] bg-black"></div>
          <h1 class="font-display text-xl md:text-2xl text-black uppercase">
            Admin
          </h1>
        </div>
        <a 
          href="/" 
          class="px-4 py-2 bg-yellow border-2 border-black rounded-md font-heading text-sm font-bold uppercase tracking-wide hover:bg-yellow/80 transition-colors shadow-sm"
        >
          Volver al Sitio
        </a>
      </div>
    </div>
  </header>

  <main id="main-content" class="min-h-screen bg-cream py-8 md:py-12">
    <div class="container mx-auto px-4 sm:px-6 md:px-8 lg:px-12 xl:px-16">
      
      <!-- Header -->
      <div class="mb-8 md:mb-12 fade-in-up">
        <h2 class="font-display text-4xl md:text-5xl lg:text-6xl text-black uppercase mb-4 leading-tight tracking-tight">
          Panel de Administraci칩n
        </h2>
        <p class="font-body text-base md:text-lg text-dark">
          Gesti칩n de participantes registrados
        </p>
      </div>

      {error ? (
        <!-- Error State -->
        <div class="bg-error-light/20 border-[4px] border-error shadow-[6px_6px_0px_0px_rgba(26,26,26,1)] p-6 md:p-8 rounded-lg">
          <h2 class="font-heading text-xl md:text-2xl font-bold text-error uppercase mb-2">
            Error al cargar registros
          </h2>
          <p class="font-body text-dark">{error}</p>
        </div>
      ) : (
        <>
          <!-- M칠tricas Principales: Totales Generales -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-8 md:mb-10">
            <!-- Total Solicitudes Todas -->
            <div class="bg-gradient-to-br from-yellow via-orange to-pink border-[4px] border-black shadow-[6px_6px_0px_0px_rgba(26,26,26,1)] p-6 md:p-8 text-center transform hover:-translate-x-[2px] hover:-translate-y-[2px] hover:shadow-[8px_8px_0px_0px_rgba(26,26,26,1)] transition-all">
              <div class="font-display text-5xl md:text-6xl text-black mb-2 leading-none">{totalRegistrations}</div>
              <div class="font-heading text-sm md:text-base font-bold text-black uppercase tracking-wide">TOTAL SOLICITUDES</div>
            </div>

            <!-- Total Aprobadas -->
            <div class="bg-success-light border-[4px] border-black shadow-[6px_6px_0px_0px_rgba(26,26,26,1)] p-6 md:p-8 text-center transform hover:-translate-x-[2px] hover:-translate-y-[2px] hover:shadow-[8px_8px_0px_0px_rgba(26,26,26,1)] transition-all">
              <div class="font-display text-5xl md:text-6xl text-white-warm mb-2 leading-none">{approvedCount}</div>
              <div class="font-heading text-sm md:text-base font-bold text-white-warm uppercase tracking-wide">TOTAL APROBADAS</div>
            </div>

            <!-- Total Denegadas -->
            <div class="bg-error-light border-[4px] border-black shadow-[6px_6px_0px_0px_rgba(26,26,26,1)] p-6 md:p-8 text-center transform hover:-translate-x-[2px] hover:-translate-y-[2px] hover:shadow-[8px_8px_0px_0px_rgba(26,26,26,1)] transition-all">
              <div class="font-display text-5xl md:text-6xl text-white-warm mb-2 leading-none">{rejectedCount}</div>
              <div class="font-heading text-sm md:text-base font-bold text-white-warm uppercase tracking-wide">TOTAL DENEGADAS</div>
            </div>
          </div>

          <!-- Total por Categor칤a Aprobadas -->
          <div class="mb-8 md:mb-10">
            <h2 class="font-display text-2xl md:text-3xl text-black uppercase mb-4 md:mb-6 text-center">
              Aprobadas por Categor칤a
            </h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 md:gap-6">
              {categories.map((category) => {
                const count = approvedByCategory[category] || 0;
                const colors = {
                  'Open Hombres': 'bg-yellow',
                  'Open Mujeres': 'bg-orange',
                  'Mujeres Intermedio': 'bg-pink',
                  'Mujeres Principiante': 'bg-yellow/80',
                  'Ni침os': 'bg-orange/80'
                };
                const label = categoryLabels[category] || category;
                return (
                  <div class={`${colors[category as keyof typeof colors] || 'bg-white-warm'} border-[4px] border-black shadow-[6px_6px_0px_0px_rgba(26,26,26,1)] p-5 md:p-6 text-center transform hover:-translate-x-[2px] hover:-translate-y-[2px] hover:shadow-[8px_8px_0px_0px_rgba(26,26,26,1)] transition-all`}>
                    <div class="font-display text-3xl md:text-4xl text-black mb-2 leading-none">{count}</div>
                    <div class="font-heading text-xs md:text-sm font-bold text-black uppercase tracking-wide leading-tight">{label}</div>
                  </div>
                );
              })}
            </div>
          </div>

          <!-- Lista de Registros -->
          <div class="bg-white-warm border-[4px] border-black shadow-[8px_8px_0px_0px_rgba(26,26,26,1)] p-6 md:p-8 lg:p-10">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6 md:mb-8 gap-4">
              <h2 class="font-display text-2xl md:text-3xl lg:text-4xl text-black uppercase leading-tight">
                Participantes Registrados
              </h2>
              <div class="font-body text-sm md:text-base text-dark">
                Total: <span class="font-bold text-black">{totalRegistrations}</span> participantes
              </div>
            </div>

            {registrations.length === 0 ? (
              <div class="text-center py-12 md:py-16">
                <div class="text-6xl mb-4">游늶</div>
                <p class="font-body text-lg md:text-xl text-dark">
                  No hay participantes registrados a칰n
                </p>
              </div>
            ) : (
              <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                  <thead>
                    <tr class="bg-black text-white-warm">
                      <th class="font-heading text-xs md:text-sm font-bold uppercase tracking-wide px-4 py-3 md:px-6 md:py-4 text-left border-2 border-black">#</th>
                      <th class="font-heading text-xs md:text-sm font-bold uppercase tracking-wide px-4 py-3 md:px-6 md:py-4 text-left border-2 border-black">Participante</th>
                      <th class="font-heading text-xs md:text-sm font-bold uppercase tracking-wide px-4 py-3 md:px-6 md:py-4 text-left border-2 border-black">Categor칤a</th>
                      <th class="font-heading text-xs md:text-sm font-bold uppercase tracking-wide px-4 py-3 md:px-6 md:py-4 text-left border-2 border-black">Comprobante</th>
                      <th class="font-heading text-xs md:text-sm font-bold uppercase tracking-wide px-4 py-3 md:px-6 md:py-4 text-left border-2 border-black">Estado</th>
                      <th class="font-heading text-xs md:text-sm font-bold uppercase tracking-wide px-4 py-3 md:px-6 md:py-4 text-left border-2 border-black">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="registrations-table-body">
                    {registrations.map((reg, index) => {
                      const categoryColors = {
                        'Open Hombres': 'bg-yellow/30',
                        'Open Mujeres': 'bg-orange/30',
                        'Mujeres Intermedio': 'bg-pink/30',
                        'Mujeres Principiante': 'bg-yellow/20',
                        'Ni침os': 'bg-orange/20'
                      };
                      
                      return (
                        <tr 
                          class={`border-2 border-black/20 ${index % 2 === 0 ? 'bg-white-warm' : 'bg-cream'} hover:bg-yellow/20 transition-colors`}
                          data-registration-id={reg.id}
                        >
                          <td class="font-body text-sm md:text-base text-black px-4 py-3 md:px-6 md:py-4 border-2 border-black/10 font-bold">{index + 1}</td>
                          <td class="font-body text-sm md:text-base text-black px-4 py-3 md:px-6 md:py-4 border-2 border-black/10 font-medium">
                            <div class="font-medium">{reg.name}</div>
                            <div class="text-xs text-gray mt-1">{reg.email}</div>
                            <div class="text-xs text-gray">{reg.phone}</div>
                          </td>
                          <td class="font-body text-sm md:text-base px-4 py-3 md:px-6 md:py-4 border-2 border-black/10">
                            <span class={`inline-block px-3 py-1 rounded-md border-2 border-black font-heading text-xs font-bold uppercase ${categoryColors[reg.category as keyof typeof categoryColors] || 'bg-white-warm'} text-black`}>
                              {reg.category}
                            </span>
                          </td>
                          <td class="font-body text-sm md:text-base px-4 py-3 md:px-6 md:py-4 border-2 border-black/10">
                            {reg.payment_receipt_url ? (
                              <a 
                                href={reg.payment_receipt_url} 
                                target="_blank" 
                                rel="noopener noreferrer"
                                class="inline-flex items-center gap-2 px-3 py-1.5 bg-yellow border-2 border-black rounded-md font-heading text-xs font-bold uppercase hover:bg-yellow/80 transition-colors shadow-sm"
                              >
                                <span>游늯</span>
                                <span>Ver</span>
                              </a>
                            ) : (
                              <span class="text-xs text-gray italic">Sin comprobante</span>
                            )}
                          </td>
                          <td class="font-body text-sm md:text-base px-4 py-3 md:px-6 md:py-4 border-2 border-black/10">
                            {reg.status === 'pending' && (
                              <span class="inline-block px-3 py-1 rounded-md border-2 border-yellow bg-yellow text-black font-heading text-xs font-bold uppercase">
                                Pendiente
                              </span>
                            )}
                            {reg.status === 'approved' && (
                              <span class="inline-block px-3 py-1 rounded-md border-2 border-success bg-success-light text-white-warm font-heading text-xs font-bold uppercase">
                                Aprobada
                              </span>
                            )}
                            {reg.status === 'rejected' && (
                              <span class="inline-block px-3 py-1 rounded-md border-2 border-error bg-error-light text-white-warm font-heading text-xs font-bold uppercase">
                                Rechazada
                              </span>
                            )}
                          </td>
                          <td class="font-body text-sm md:text-base px-4 py-3 md:px-6 md:py-4 border-2 border-black/10">
                            <client:only>
                              <RegistrationActions 
                                registrationId={reg.id}
                                currentStatus={reg.status}
                                onStatusUpdate={(id, newStatus) => {
                                  // Recargar la p치gina para reflejar cambios
                                  window.location.reload();
                                }}
                              />
                            </client:only>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            )}
          </div>
        </>
      )}
    </div>
  </main>
</AdminLayout>

<style>
  .fade-in-up {
    animation: fadeInUp 0.6s ease-out;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 640px) {
    table {
      font-size: 0.75rem;
    }
  }
</style>

